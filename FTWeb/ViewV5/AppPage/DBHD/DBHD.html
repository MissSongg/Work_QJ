<style>
    #tab.table > thead > tr > th, #tab.table > tbody > tr > th, #tab.table > tfoot > tr > th, #tab.table > thead > tr > td, #tab.table > tbody > tr > td, #tab.table > tfoot > tr > td {
        vertical-align: middle;
        text-align: center;
    }

    .default-tab input, .default-tab select {
        border: none;
        box-shadow: none !important;
    }

    a .iconfont {
        margin-right: 5px;
        font-size: 12px;
    }
</style>
<div class="form-horizontal" ms-controller="DBHD">
    <div style="margin: 0 80px;">
        <div>
            <!--<div class="fg-item"><span>基本信息</span></div>-->
            <ul class="clearfix" style="display: block; padding: 0">

                <li class="add-item add-width">
                    <label>申请人:</label><label>{{ComFunJS.convertuser(modelData.CRUser)}}</label>
                </li>
                <li class="add-item add-width">
                    <label class="add-item-label"><i>*</i>起止时间</label>
                    <div class="add-ic">
                        <div style="display: block;">
                            <div class="add-ic fl-left" style="width: 45%;">
                                <input type="text" class="form-control szhl_form_date_time szhl_require" ms-class-1="null:modelData.ID" ms-duplex="modelData.KSDate">
                            </div>
                            <div class="add-ic" style="float: left; line-height: 30px; width: 10%; text-align: center;">：</div>
                            <div class="add-ic fl-right" style="width: 45%;">
                                <input type="text" class="form-control szhl_form_date_time szhl_require" ms-class-1="null:modelData.ID" ms-duplex="modelData.JSDate">
                            </div>
                        </div>
                    </div>
                </li>
                <li class="add-item add-widthall">
                    <label class="add-item-label"><i>*</i>标题</label>
                    <div class="add-ic">
                        <input type="text" autofocus="autofocus" class="form-control  szhl_require" ms-duplex="modelData.Title">
                    </div>
                </li>
                <li class="add-item add-widthall">
                    <label class="add-item-label"><i>*</i>活动明细</label>
                    <div class="default-tab ft14 pt20">
                        <table class="table table-hover table-bordered" id="tab">
                            <thead style="background: #f7f7f7;">
                                <tr>
                                    <th width="140px">购买金额(元)</th>
                                    <th width="140px">参团人数</th>
                                    <th width="140px">购买次数限制</th>
                                    <th width="200px">奖项</th>
                                    <th width="50px" ms-if="pmodel.isedit=='Y'">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ms-repeat-item="DBHDJLLIST">
                                    <td>{{item.GMJE}}</td>
                                    <td>{{item.CTRS}}</td>
                                    <td>{{item.CSXZ}}</td>
                                    <td>{{item.Remark}}</td>
                                    <td ms-if="pmodel.isedit=='Y'"><a class=" btn btn-warning btn-sm" ms-click="RemoveJL(item)"><i class="iconfont icon-shanchu"></i>删除</a></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr ms-if="pmodel.isedit=='Y'">
                                    <td>
                                        <input type="text" class="form-control" ms-duplex="DBHDJL.GMJE" placeholder="请输入金额" />

                                    </td>
                                    <td>
                                        <input type="text" class="form-control" ms-duplex="DBHDJL.CTRS" placeholder="请输入参团人数" />

                                    </td>
                                    <td>
                                        <input type="text" class="form-control" ms-duplex="DBHDJL.CSXZ" placeholder="请输入次数限制" />
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" ms-duplex="DBHDJL.Remark" placeholder="请输入奖项说明" />

                                    </td>

                                    <td><a class="btn btn-info  btn-sm" ms-click="AddDBHDJL()"><i class="iconfont icon-jiahao"></i>添加</a></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </li>

                <li class="add-item add-widthall">
                    <label class="add-item-label">活动描述</label>
                    <div class="add-ic">
                        <textarea ms-duplex="modelData.Content" rows="2" class="span2 form-control"></textarea>
                    </div>
                </li>
                <li class="add-item add-widthall">
                    <label class="add-item-label">附件</label>
                    <div class="add-ic">
                        <input type="text" ms-duplex="modelData.Files" class="span2  szhl_Upload form-control" />
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    var tempmodel = avalon.define({
        $id: "DBHD",
        ColumnData: [],
        XMData: [],
        name: "夺宝活动",
        iswf: true,//是否属于流程表单
        inittemp: function (strId) {
            if (strId) {
                //编辑加载数据
                $.getJSON('/API/VIEWAPI.ashx?Action=DBHD_GETDBHDMODEL', { P1: strId }, function (resultData) {
                    if (resultData.ErrorMsg == "") {
                        tempmodel.modelData = resultData.Result;
                        tempmodel.DBHDJLLIST = resultData.Result1;
                        setTimeout("ComFunJS.initForm()", 500)

                    }
                })
            } else {
                if (localStorage.getItem(pmodel.FormCode) && localStorage.getItem(pmodel.FormCode) != JSON.stringify(tempmodel.modelData.$model)) {//判断有没有未保存的表单
                    var tempdata = localStorage.getItem(pmodel.FormCode);//缓存表单数据
                    ComFunJS.winconfirm("系统检测到您未保存的数据,是否加载?", function () {
                        tempmodel.modelData = $.parseJSON(tempdata);
                        ComFunJS.initForm();
                    }, function () {
                        localStorage.removeItem(pmodel.FormCode);
                        ComFunJS.initForm();
                    })
                } else {
                    pmodel.isDraft = true;
                    ComFunJS.initForm();
                }
                //$(".btnSucc").text("送审");
            }
        },//初始化
        modelData: { "KSDate": "", "JSDate": "", "Content": "", "Files": "", "Title": "", "CRUser": ComFunJS.getnowuser() },
        DBHDJL: { "GMJE": "", "CTRS": "", "CSXZ": "", "Remark": "" },
        DBHDJLLIST: [],
        //存草稿使用
        GetDraftData: function () {
            return { "modelData": tempmodel.modelData.$model, "DBHDJLLIST": tempmodel.DBHDJLLIST.$model };
        },
        SetDraftData: function (vm) {
            tempmodel.modelData = vm.modelData;
            tempmodel.DBHDJLLIST = vm.DBHDJLLIST;
        },
        AddDBHDJL: function () {

            if (!tempmodel.DBHDJL.CTRS) {
                top.ComFunJS.winwarning("请填写参团人数");
                return false;
            }
            if (!tempmodel.DBHDJL.Remark) {
                top.ComFunJS.winwarning("请填写备注");
                return false;
            }
            var reg = /^\d+(?:.\d{1,2})?$/;
            if (!reg.test(tempmodel.DBHDJL.GMJE)) {
                top.ComFunJS.winwarning("购买金额只能是数字，且最多只能两位小数");
                return false;
            }
            if (!tempmodel.DBHDJL.CSXZ) {
                top.ComFunJS.winwarning("次数限制");
                return false;
            }

            var dbhdModel = $.extend(false, {}, tempmodel.DBHDJL.$model);
            tempmodel.DBHDJLLIST.push(dbhdModel);
            tempmodel.DBHDJL = { "GMJE": "", "CTRS": "", "CSXZ": "", "Remark": "" };
        },
        RemoveJL: function (item) {
            tempmodel.DBHDJLLIST.remove(item);
        },
        SaveData: function (callback, dom) {
            if (tempmodel.modelData.Title.length > 20) {
                top.ComFunJS.winwarning("请输入长度20位及20位一下的报销标题");

                $(dom).attr("disabled", false).find(".fa").hide();//加上转圈样式
                return false;
            }
            if (tempmodel.DBHDJLLIST.size() == 0) {
                top.ComFunJS.winwarning("请添夺宝记录");

                $(dom).attr("disabled", false).find(".fa").hide();//加上转圈样式
                return false;
            }
            $.post("/API/VIEWAPI.ashx?ACTION=DBHD_ADDDBHD", { P1: JSON.stringify(tempmodel.modelData.$model), P2: JSON.stringify(tempmodel.DBHDJLLIST.$model) }, function (result) {
                return callback.call(this, $.parseJSON(result));
            });
        }
    });

    tempmodel.$watch("modelData.*", function (a, b) {
        if (!tempmodel.modelData.ID) {
            localStorage.setItem(pmodel.FormCode, JSON.stringify(tempmodel.modelData.$model));
        }
    })  //@ sourceURL=DBHD.js;
</script>
